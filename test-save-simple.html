<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Save to Supabase</title>
</head>
<body>
    <h1>–¢–µ—Å—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ Supabase</h1>
    <p>–ü–æ—Ç–æ—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –±–ª–æ–∫–Ω–æ—Ç–∞: <span id="currentQty">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span></p>
    <button id="decreaseBtn">–ó–º–µ–Ω—à–∏—Ç–∏ –±–ª–æ–∫–Ω–æ—Ç –Ω–∞ 1</button>
    <button id="checkBtn">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è</button>
    <div id="log"></div>

    <script>
        const API_URL = 'https://merch-count1.netlify.app/.netlify/functions';
        
        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}<br>`;
            console.log(message);
        }

        async function getCurrentQty() {
            try {
                const response = await fetch(`${API_URL}/inventory`);
                const data = await response.json();
                const notebook = data.inventory.find(item => item.sku === 'notebook');
                return notebook ? notebook.qty : null;
            } catch (error) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${error.message}`);
                return null;
            }
        }

        async function updateQty(newQty) {
            try {
                log(`üíæ –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –±–ª–æ–∫–Ω–æ—Ç: ${newQty}`);
                const response = await fetch(`${API_URL}/update-inventory`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        updates: [{ sku: 'notebook', variant: 'default', qty: newQty }]
                    })
                });
                const result = await response.json();
                log(`üì§ –í—ñ–¥–ø–æ–≤—ñ–¥—å API: ${JSON.stringify(result)}`);
                return result.success;
            } catch (error) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ${error.message}`);
                return false;
            }
        }

        async function updateDisplay() {
            const qty = await getCurrentQty();
            document.getElementById('currentQty').textContent = qty !== null ? qty : '–ü–æ–º–∏–ª–∫–∞';
            log(`üìä –ü–æ—Ç–æ—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å: ${qty}`);
        }

        document.getElementById('decreaseBtn').addEventListener('click', async () => {
            const currentQty = await getCurrentQty();
            if (currentQty !== null && currentQty > 0) {
                const newQty = currentQty - 1;
                log(`üîÑ –ó–º—ñ–Ω—é—î–º–æ –∑ ${currentQty} –Ω–∞ ${newQty}`);
                const success = await updateQty(newQty);
                if (success) {
                    log('‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–µ!');
                    setTimeout(updateDisplay, 1000); // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
                } else {
                    log('‚ùå –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–µ –≤–¥–∞–ª–æ—Å—è!');
                }
            }
        });

        document.getElementById('checkBtn').addEventListener('click', updateDisplay);

        // –ü–æ—á–∞—Ç–∫–æ–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        updateDisplay();
    </script>
</body>
</html>
